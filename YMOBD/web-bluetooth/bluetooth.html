<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Bluetooth</title>
  <script src="./util.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    #app{
      /* text-align: center; */
      padding: 3rem 1rem 0;
    }
    .floatingView{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, .15);
      color: #f00;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0;
      /* font-weight: bold; */
    }
    .container{
      display: flex;
      flex-direction: column;
    }

    h2{
      border-left: 3px solid blue;
      /* border-bottom: 1px solid #ccc; */
      font-size: 1.5rem;
      padding: 0 0.5rem;
      margin: 1rem 0;
      color: #333;
    }

    button {
      display: inline-block;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: bold;
      text-align: center;
      text-transform: uppercase;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }

    button:hover {
      cursor: pointer;
      transform: translateY(-2px);
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

   
    input[type="text"],
    input[type="password"],
    input[type="email"] {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-shadow: none;
      transition: border-color 0.3s ease;
      margin-bottom: 1rem;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus {
      outline: none;
      border-color: #007bff;
    }

    input[type="text"]::placeholder,
    input[type="password"]::placeholder,
    input[type="email"]::placeholder {
      color: #999;
    }

    input[type="text"]:hover,
    input[type="password"]:hover,
    input[type="email"]:hover {
      border-color: #ccc;
    }

    textarea {
      box-sizing: border-box;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-shadow: none;
      transition: border-color 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: #007bff;
    }

    textarea::placeholder {
      color: #999;
    }

    textarea:hover {
      border-color: #ccc;
    }

    footer{
      margin-top: 15px;
    }
    
    li{
      font-size: 1rem;
      color: #333;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="floatingView">{{errMsg}}</div>

    <div v-if="!isConnected">
      <button id="z-button" class="z-button" @click="connectOBD">连接蓝牙</button>
      
    </div>

    <div class="container">
      <div>
        <h2>请输入要发送的指令</h2>
        <input type="text" v-model="inputValue" placeholder="请输入指令">
        <button @click="custom_pid">发送单个指令</button>
        <button @click="test_pid">测试所有指令</button>
      </div>

      <div>
        <h2>数据发送和回复记录 <button @click="dataFlow=''">重置</button></h2>
        <div>
          <textarea name="" id="" cols="30" rows="20" v-model="dataFlow" readonly></textarea>
        </div>
        <!-- <div v-html="dataFlow" class="container"></div> -->
       
      </div>
    </div>
    
    <!-- <footer>
      <div>参考文档</div>
      <ul>
        <li>
          <a href="https://webbluetoothcg.github.io/web-bluetooth/#bluetooth" target="_blank">Web Bluetooth提案</a>
        </li>
        <li>
          <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Bluetooth" target="_blank">MDN社区 Bluetooth</a>
        </li>
      </ul>
    </footer> -->
    
  </div>

  
  <script>
  const app = new Vue({
    el: '#app',
    data: {
      isConnected: false,
      queue: [], // 当前任务队列
      currentIndex: 0, // 当前任务下标
      currentCMD: null, // 当前正在执行的指令
      errMsg: '请先点击连接蓝牙', // 异常信息
      dataFlow: '',
      isReady: true, // 当时是否准备好
      characteristic_write: null, // 写入的特征值
      characteristic_notify: null, // 订阅的特征值
      tem: '',// 数据存储
      inputValue: "", // 手动输入的值
    },
    created() {
      // console.log(this.tem, this.dataFlow, this.$data)
      // console.log(PIDs)
      // console.log(CryptoJS)
    },
    computed: {
      list() {
        return [
          
        ]
      }
    },
    methods: {
      connectOBD(){
        try {
          const UUID = "0000FFF0-0000-1000-8000-00805F9B34FB".toLowerCase()
          let option = {
            filters: [
              {services: [UUID]},
              // {name: 'B25'},
              // {namePrefix: '前缀'}
            ],
            // optionalServices: [UUID], // 必须小写
            acceptAllDevices: false, // filters存在时位false, 否则为true
          }
          navigator.bluetooth.requestDevice(option).then(async (device)=>{
            console.log('1-设备信息', device)
            let deviceName = device.gatt.device.name;
            this.errMsg = `${device.name} 已连接`
            const server = await device.gatt.connect(); // 连接到 GATT 服务器
            // const OBDII_services = await server.getPrimaryServices(); // 获取所有服务
            // console.log('所有服务', OBDII_services)
            const OBDII_service = await server.getPrimaryService(UUID); // 获取指定服务
            console.log('2-服务信息', OBDII_service)
            // 获取服务的特征值缓冲区
            const characteristics = await OBDII_service.getCharacteristics() // 获取所有特征值
            console.log('3-所有特征值', characteristics)
            let notifyUUID = null
            let writeUUID = null
            for (let i = 0; i < characteristics.length; i++) {
              const item = characteristics[i];
              // 可通知属性
              if(item.properties.notify || item.properties.indicate){
                notifyUUID = item.uuid
              }
              // 可写,只有一个特征值
              if(item.properties.write){
                writeUUID = item.uuid
              }
            }
            // 获取服务的特征值缓冲区
            this.characteristic_notify = await OBDII_service.getCharacteristic(notifyUUID)// 获取指定特征值
            console.log('4-通知特征值', this.characteristic_notify)
            this.characteristic_write = await OBDII_service.getCharacteristic(writeUUID)// 获取指定特征值
            console.log('5-写入特征值', this.characteristic_write)

            console.log('6-启动订阅，开始监听特征值变化', )
            this.onBLECharacteristicValueChange() // 监听低功耗蓝牙设备特征值变化
            this.characteristic_notify.startNotifications(); // 启用监听特征值改变
            this.isConnected = true
            // 执行默认队列
            let queue = ['ATZ', 'ATE0', 'ATL0', 'ATH1', 'ATSP0', 'AT+VERSION', 'ATI', '0100', 'ATDP', "ATRV"]
            this.queue = queue
            this.writeCmd()
          })
          .catch(function(error) {
            console.log("出现错误： " , error);
            alert(error.message)
          });
        } catch (exception) {
          console.error(exception);
          this.errMsg = exception
          alert("获取设备详细信息时发生错误");
        }
      },
      // 写数据
      writeCmd(){
        if(!this.isReady){
          console.log('当前有未完成的指令', this.currentCMD)
          return
        }
        let cmd = this.queue[this.currentIndex]
        this.errMsg = `正在发送指令 ${cmd}`

        let _cmd = new TextEncoder().encode(cmd + '\r').buffer // 格式化cmd
        this.characteristic_write.writeValue(_cmd).then( async(res)=>{
          console.log(this.formatTime(), '发送指令成功', cmd)
          this.isReady = false
          // this.dataFlow = `发送: ${cmd}\r\n` + this.dataFlow // 发送记录
          this.currentCMD = cmd
        }).catch((error)=>{
          console.log('发送失败',error)
        })
      },
      // 接收回复消息
      onBLECharacteristicValueChange(){
        // 监听低功耗蓝牙设备特征值变化,必须先启用startNotifications，才能监听到
        this.characteristic_notify.addEventListener('characteristicvaluechanged', e => {
          let value = e.target.value // 当前帧返回的数据
          let chunk = new TextDecoder().decode(value)
          // console.log('特征值变化', this.tem, chunk)
          this.tem += chunk // 当前命令返回的总数据
          if(this.tem.includes('>')){
            // console.log('接收完成', this.tem)
            this.isReady = true
            this.dataFlow = `\r\n发送：${this.currentCMD}\r\n回复: ${this.tem.replace(/[ ]|[\r]|[\n]|[\r\n]/g, "")}\r\n格式化后: ${this.formatData(this.currentCMD, this.tem)}\r\n` + this.dataFlow

            let print = `发送：${this.currentCMD}\r\n回复: ${this.tem}\r\n格式化后: ${this.formatData(this.currentCMD, this.tem)}`
            console.log(print);
            this.tem = '' // 接收完成。重制数据
            if((this.currentIndex + 1) < this.queue.length ){
              this.currentIndex++
              this.writeCmd()
            }else{
              this.queue = []
              this.currentIndex = 0
              this.errMsg = `发送 ${this.currentCMD} 完成`
              console.log('===== 队列已执行完成 =====')
            }
          }
        });
      },
      formatData(cmd, data){
        let result = 'NO DATA'
        if(data.includes('NO DATA')){
          console.warn('无数据', cmd, data)
        }
        if (cmd.substring(0, 2) === '01'){
          let condition = ['0100', '0120', '0140', '0101', '0141'].includes(cmd)
          result = condition ? getSupport(cmd, data) : get$01(cmd, data)
        }else if(cmd.substring(0, 2) === '02'){
          let condition = ['0200', '0220', '0240'].includes(cmd.substring(0, 4))
          result =  condition ? getSupport$02(cmd, data) : get$02(cmd, data)
        }else if(['03', '07', '0A'].includes(cmd)){
          result = getDTC(cmd, data)
        }else if(cmd.substring(0, 2) === '05'){
          let condition = ["0500", "0520", "0540", "0560", "0580", "05A0", "05C0", "05E0"].includes(cmd.substring(0, 4))
          result = condition ? getSupport(cmd, data): get$05(cmd, data)
        }else if(cmd.substring(0, 2) === '06'){
          let condition = ["0600", "0620", "0640", "0660", "0680", "06A0", "06C0", "06E0"].includes(cmd.substring(0, 4))
          result = condition ? getSupport(cmd, data): get$06(cmd, data)
        }else if(cmd.substring(0, 2) === '09'){
          let condition = '0900' === cmd
          result = condition ? getSupport(cmd, data): get$09(cmd, data)
        }else if(['10', '3E', "27", "22", "2E", "14", "19"].includes(cmd.substring(0, 2))){
          let condition = cmd.substring(0, 4) === '1902'
          result = condition ? getUDSDTC(cmd, data): data
        }else if(cmd.substring(0, 2) === 'AT'){
          result = data.replace(/[ ]|[\r]|[\n]|[\r\n]|[>]/g, "")
          if(cmd === 'ATDP'){
            // 【重要】把需要使用的协议存储在缓存内,解析数据需要用到 wx.getStorageSync('____ATDP')
            // wx.setStorageSync('____ATDP', result)
            // 【重要】把需要使用的协议存储在缓存内,解析数据需要用到 localStorage.getItem('____ATDP')
            localStorage.setItem('____ATDP', result);
          }
        }else{
          result = data
        }
        return result
      },
      custom_pid(){
        if(!this.isConnected){
          alert('错误！请先连接蓝牙再测试！')
          return
        }
        this.queue.push(this.inputValue)
        this.writeCmd()
      },

      test_pid(){
        if(!this.isConnected){
          alert('错误！请先连接蓝牙再测试！')
          return
        }
        // 执行默认队列
        let queue = ["ATRV",  "020200", "020000", "022000", "024000", "020C00", "020D00", "03", "07", "0A", "04", "05", "06", "0900", "0902", "0904", "0906", "0908", "090A", "090B", "010C", "010D"]
        for (let i = 0; i < 96; i++) {
          let hex = i.toString(16).toUpperCase()
          let cmd_01 =  (hex.length < 2 ? "010" : '01') + hex
          queue.push(cmd_01)
        }
        this.queue = queue
        this.writeCmd()
      },
      formatTime() {
        let date = new Date()
        const year = date.getFullYear()
        const month = date.getMonth() + 1
        const day = date.getDate()
        const hour = date.getHours()
        const minute = date.getMinutes()
        const second = date.getSeconds()
        const milliseconds = date.getMilliseconds()
        const formatNumber = n => {
            n = n.toString()
            return n[1] ? n : '0' + n
        }
        return [year, month, day].map(formatNumber).join('-') + ' ' + [hour, minute, second].map(formatNumber).join(':') + ':' + milliseconds 
      }
    }
  })

  </script>
</body>
</html>