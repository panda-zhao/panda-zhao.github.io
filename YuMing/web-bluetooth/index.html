<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Bluetooth</title>
  <script src="./util.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    #app{
      /* text-align: center; */
      padding: 3rem 1rem 0;
    }
    .header{
      display: flex;
      align-items: center;
      
    }
    .floatingView{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, .15);
      color: #f00;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0;
      /* font-weight: bold; */
    }
    .container{
      display: flex;
      flex-direction: column;
    }

    h2{
      border-left: 3px solid blue;
      /* border-bottom: 1px solid #ccc; */
      font-size: 1.5rem;
      padding: 0 0.5rem;
      margin: 1rem 0;
      color: #333;
    }

    button {
      display: inline-block;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: bold;
      text-align: center;
      text-transform: uppercase;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }

    button:hover {
      cursor: pointer;
      transform: translateY(-2px);
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

   
    input[type="text"],
    input[type="password"],
    input[type="email"] {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-shadow: none;
      transition: border-color 0.3s ease;
      margin-bottom: 1rem;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus {
      outline: none;
      border-color: #007bff;
    }

    input[type="text"]::placeholder,
    input[type="password"]::placeholder,
    input[type="email"]::placeholder {
      color: #999;
    }

    input[type="text"]:hover,
    input[type="password"]:hover,
    input[type="email"]:hover {
      border-color: #ccc;
    }

    textarea {
      box-sizing: border-box;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      box-shadow: none;
      transition: border-color 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: #007bff;
    }

    textarea::placeholder {
      color: #999;
    }

    textarea:hover {
      border-color: #ccc;
    }

    .footer{
      margin-top: 15px;
      color: blue;
      text-align: center;
    }
    
    li{
      font-size: 1rem;
      color: #333;
      margin-bottom: 0.5rem;
    }
    .switch {
      width: 50px;
      height: 25px;
      background-color: #ccc;
      border-radius: 25px;
      position: relative;
      transition: background-color 0.3s;
      cursor: pointer;
      margin: 0 20px 0 10px;
    }

    .switch.is-on {
      background-color: #4cd964;
    }

    .switch-handle {
      width: 23px;
      height: 23px;
      background-color: #fff;
      border-radius: 50%;
      position: absolute;
      top: 1px;
      left: 1px;
      transition: left 0.3s;
    }

    .switch.is-on .switch-handle {
      left: 24px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="floatingView">{{errMsg}}</div>

    <div v-if="!isConnected" class="header">
      æ˜¯å¦åŠ å¯†
      <div class="switch" :class="{ 'is-on': isEncrypted }" @click="isEncrypted = !isEncrypted">
        <div class="switch-handle"></div>
      </div>
      <!-- <button id="z-button" class="z-button" @click="connectOBD">æ˜¯å¦åŠ å¯†</button> -->
      <button id="z-button" class="z-button" @click="connectOBD">è¿æ¥è“ç‰™</button>
    </div>

    <div class="footer" v-else>å½“å‰åè®®ï¼š{{ATDP}}[{{isConnected ? 'åŠ å¯†æ¨¡å¼': 'æœªåŠ å¯†'}}]</div>

    <div class="container">
      <div>
        <h2>è¯·è¾“å…¥è¦å‘é€çš„æŒ‡ä»¤</h2>
        <input type="text" v-model="inputValue" placeholder="è¯·è¾“å…¥æŒ‡ä»¤">
        <button @click="custom_pid">å‘é€å•ä¸ªæŒ‡ä»¤</button>
        <button @click="test_pid">æµ‹è¯•æ‰€æœ‰æŒ‡ä»¤</button>
      </div>

      <div>
        <h2>æ•°æ®å‘é€å’Œå›å¤è®°å½• <button @click="dataFlow=''">é‡ç½®</button></h2>
        <div>
          <textarea name="" id="" cols="30" rows="20" v-model="dataFlow" readonly></textarea>
        </div>
        <!-- <div v-html="dataFlow" class="container"></div> -->
       
      </div>
    </div>
    
    
    <!-- <footer>
      <div>å‚è€ƒæ–‡æ¡£</div>
      <ul>
        <li>
          <a href="https://webbluetoothcg.github.io/web-bluetooth/#bluetooth" target="_blank">Web Bluetoothææ¡ˆ</a>
        </li>
        <li>
          <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Bluetooth" target="_blank">MDNç¤¾åŒº Bluetooth</a>
        </li>
      </ul>
    </footer> -->
    
  </div>

  
  <script>
  const app = new Vue({
    el: '#app',
    data: {
      ATDP: 'AUTO, ISO 15765-4 (CAN 29/500)', // ISO14230-4(KWP FAST) AUTO, ISO 15765-4 (CAN 29/500)
      isEncrypted: false,
      isConnected: false,
      queue: [], // å½“å‰ä»»åŠ¡é˜Ÿåˆ—
      currentIndex: 0, // å½“å‰ä»»åŠ¡ä¸‹æ ‡
      currentCMD: null, // å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤
      errMsg: 'è¯·å…ˆç‚¹å‡»è¿æ¥è“ç‰™', // å¼‚å¸¸ä¿¡æ¯
      dataFlow: '',
      isReady: true, // å½“æ—¶æ˜¯å¦å‡†å¤‡å¥½
      characteristic_write: null, // å†™å…¥çš„ç‰¹å¾å€¼
      characteristic_notify: null, // è®¢é˜…çš„ç‰¹å¾å€¼
      tem: '',// æ•°æ®å­˜å‚¨
      inputValue: "", // æ‰‹åŠ¨è¾“å…¥çš„å€¼
    },
    created() {
      // console.log(this.tem, this.dataFlow, this.$data)
      // console.log(PIDs)
      // console.log(CryptoJS)
      console.log('å½“å‰çš„åè®®', localStorage.getItem('____ATDP'))
      // this.formatData('050101', '486B00 4501 01 6862\r\r>')
      // this.formatData('050201', '486B00 4502 01 6863\r\r>')
      // this.formatData('050401', '486B00 4504 01 6865\r\r>')
      // this.formatData('050601', '486B00 4506 01 23002A4C\r\r>')
      // this.formatData('050102', '486B00 4501 02 6863\r\r>')
      // this.formatData('050202', '486B00 4502 02 6864\r\r>')

      // this.formatData('0A', '83F110 7F 0A111E>') // [)
      // this.formatData('03', '486B11 43 CFCD EDD3 2786 10\r486B11 43 B874 6D99 0000 39 >') // ["U0FCD","U2DD3","P2786","B3874","C2D99")
      // this.formatData('03', '87F112 43 2029 0082 C021 79 \r87F112 43 8090 00000000DD\r 87F118 43 2029 0082 C021 79  \r87F118 43 8090 0000 0000 DD >') // "P2029","P0082","U0021","B0090"
      // this.formatData('07', '87F111 47 0420 00000000F4>') // ["P0420")
      // this.formatData('03', '86F111 41 00BE 3E28 11 FE>'),  // [)
      // this.formatData('03', '486B10 43 0300 0480 0000 F4\r\r>') // ["P0300","P0480"]

      // this.formatData('0606', "416B10 4606 813811004AA7\r416B10460601B712DFFF64\r416B104606A137DE000B26\r416B104606213AF4BAC27F\r416B104606B137CC000BD3\r416B1046063139AFBA6155\r416B104606C237BC000A88\r416B104606423903BA2D2E\r\r>")
      // this.formatData('0601', '18DAF110 10 1C 46 01 01 0A FE DF\r18DAF110 21 90 00 B0 00 01 03 0A\r18DAF110 22 9E 41 78 00 92 AA 01\r18DAF110 23 05 10 02 DD 00 00 03\r18DAF110 24 20 00 00 00 00 00 00\r\r>')
      
      // å¤šå¸§ä¸è§„èŒƒæ•°æ®
      let mock = [
        // ["0100", "SEARCHING...\r86F1104100983B80112C\r86F11A41009818800103\r\r>"], // 10011000001110111000000000010001
        // ['0100', 'SEARCHING...\r86F110 4100 BE 3E B8 11 8D 86\rF11A 4100 98 18 80 01 03\r\r>'], // 10111110001111101011100000010001
        // ["020000", "7E8 07 420000 7E 1F 88 03\r7E9 07 420000 58 1A 80 03\r\r>"], // 01111110000111111000100000000011
        // ["020500", "486B0E 420500 FF 07\r\r>"], // 215
        // ["020200", "85F110 420200 01 98 63\r\r>"], // P0198
        // [],
        // [],
        // [],
        // [],
        ["0100", "SEARCHING...\r18 DA F1 EF 06 41 00 90 18 80 11 \r18 DA F1 1E 06 41 00 90 18 80 03 \r18 DA F1 10 06 41 00 B6 3C A8 13 \r\r>"]
      ]

      for (let item of mock) {
        const [cmd, msg] = item
        this.formatData(cmd, msg)
      }
    },
    computed: {
      // ATDP() {
      //   return localStorage.getItem('____ATDP')
      // }
    },
    methods: {
      connectOBD(){
        try {
          let UUID = "0000FFF0-0000-1000-8000-00805F9B34FB".toLowerCase() // ä¸åŠ å¯†
          if(this.isEncrypted){
            UUID = "0000FFE0-0000-1000-8000-00805F9B34FB".toLowerCase()
          }
          let option = {
            // filters: [
            //   {services: [UUID]},
            //   // {name: 'B25'},
            //   // {namePrefix: 'å‰ç¼€'}
            // ],
            optionalServices: [UUID], // å¿…é¡»å°å†™
            acceptAllDevices: true, // filterså­˜åœ¨æ—¶ä½false, å¦åˆ™ä¸ºtrue
          }
          console.log('æ˜¯å¦åŠ å¯†ğŸ”', this.isEncrypted, UUID)
          navigator.bluetooth.requestDevice(option).then(async (device)=>{
            console.log('1-è®¾å¤‡ä¿¡æ¯', device)
            let deviceName = device.gatt.device.name;
            this.errMsg = `${device.name} å·²è¿æ¥`
            const server = await device.gatt.connect(); // è¿æ¥åˆ° GATT æœåŠ¡å™¨
            // const OBDII_services = await server.getPrimaryServices(); // è·å–æ‰€æœ‰æœåŠ¡
            // console.log('æ‰€æœ‰æœåŠ¡', OBDII_services)
            const OBDII_service = await server.getPrimaryService(UUID); // è·å–æŒ‡å®šæœåŠ¡
            console.log('2-æœåŠ¡ä¿¡æ¯', OBDII_service)
            // è·å–æœåŠ¡çš„ç‰¹å¾å€¼ç¼“å†²åŒº
            const characteristics = await OBDII_service.getCharacteristics() // è·å–æ‰€æœ‰ç‰¹å¾å€¼
            console.log('3-æ‰€æœ‰ç‰¹å¾å€¼', characteristics)
            let notifyUUID = null
            let writeUUID = null
            for (let i = 0; i < characteristics.length; i++) {
              const item = characteristics[i];
              // å¯é€šçŸ¥å±æ€§
              if(item.properties.notify || item.properties.indicate){
                notifyUUID = item.uuid
              }
              // å¯å†™,åªæœ‰ä¸€ä¸ªç‰¹å¾å€¼
              if(item.properties.write){
                writeUUID = item.uuid
              }
            }
            // è·å–æœåŠ¡çš„ç‰¹å¾å€¼ç¼“å†²åŒº
            this.characteristic_notify = await OBDII_service.getCharacteristic(notifyUUID)// è·å–æŒ‡å®šç‰¹å¾å€¼
            console.log('4-é€šçŸ¥ç‰¹å¾å€¼', this.characteristic_notify)
            this.characteristic_write = await OBDII_service.getCharacteristic(writeUUID)// è·å–æŒ‡å®šç‰¹å¾å€¼
            console.log('5-å†™å…¥ç‰¹å¾å€¼', this.characteristic_write)

            console.log('6-å¯åŠ¨è®¢é˜…ï¼Œå¼€å§‹ç›‘å¬ç‰¹å¾å€¼å˜åŒ–', )
            this.onBLECharacteristicValueChange() // ç›‘å¬ä½åŠŸè€—è“ç‰™è®¾å¤‡ç‰¹å¾å€¼å˜åŒ–
            this.characteristic_notify.startNotifications(); // å¯ç”¨ç›‘å¬ç‰¹å¾å€¼æ”¹å˜
            this.isConnected = true
            // æ‰§è¡Œé»˜è®¤é˜Ÿåˆ—
            let queue = ['ATZ', 'ATE0', 'ATL0', 'ATH1', 'ATSP0', 'AT+VERSION', 'ATI', '0100', 'ATDP', "ATRV"]
            this.queue = queue
            this.writeCmd()
          })
          .catch(function(error) {
            console.log("å‡ºç°é”™è¯¯ï¼š " , error);
            alert(error.message)
          });
        } catch (exception) {
          console.error(exception);
          this.errMsg = exception
          alert("è·å–è®¾å¤‡è¯¦ç»†ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯");
        }
      },
      // å†™æ•°æ®
      writeCmd(){
        if(!this.isReady){
          console.log('å½“å‰æœ‰æœªå®Œæˆçš„æŒ‡ä»¤', this.currentCMD)
          return
        }
        let cmd = this.queue[this.currentIndex]
        this.errMsg = `æ­£åœ¨å‘é€æŒ‡ä»¤ ${cmd}`

        let _cmd = null
        _cmd = this.textEncoder(cmd)
        // let str = cmd + '\r'
        // var bufView = new Uint8Array(str.length);
        // for (var i = 0; i < str.length; i++) {
        //   bufView[i] = str.charCodeAt(i);
        // }
        // _cmd = bufView.buffer;

        this.characteristic_write.writeValue(_cmd).then( async(res)=>{
          console.log(this.formatTime(), 'å‘é€æŒ‡ä»¤æˆåŠŸ', cmd)
          this.isReady = false
          // this.dataFlow = `å‘é€: ${cmd}\r\n` + this.dataFlow // å‘é€è®°å½•
          this.currentCMD = cmd
        }).catch((error)=>{
          console.log('å‘é€å¤±è´¥',error)
        })
      },
      // æ¥æ”¶å›å¤æ¶ˆæ¯
      onBLECharacteristicValueChange(){
        // ç›‘å¬ä½åŠŸè€—è“ç‰™è®¾å¤‡ç‰¹å¾å€¼å˜åŒ–,å¿…é¡»å…ˆå¯ç”¨startNotificationsï¼Œæ‰èƒ½ç›‘å¬åˆ°
        this.characteristic_notify.addEventListener('characteristicvaluechanged', e => {
          let value = e.target.value // å½“å‰å¸§è¿”å›çš„æ•°æ®
          let chunk = this.textDecoder(value)
          console.log('ç‰¹å¾å€¼å˜åŒ–',  value, chunk)
          // let uint8Array = new Uint8Array(value)
          // let str = ''
          // for (let i = 0; i < uint8Array.length; i++) {
          //   str += String.fromCharCode(uint8Array[i]);
          // }
          // console.log('1', str)
          // chunk = decrypt(str)
          // console.log('2', chunk)
          
          this.tem += chunk // å½“å‰å‘½ä»¤è¿”å›çš„æ€»æ•°æ®
          if(this.tem.includes('>')){
            // console.log('æ¥æ”¶å®Œæˆ', this.tem)
            this.isReady = true
            let result = this.formatData(this.currentCMD, this.tem)
            this.dataFlow = `\r\nå‘é€ï¼š${this.currentCMD}\r\nå›å¤: ${this.tem.replace(/[ ]|[\r]|[\n]|[\r\n]/g, "")}\r\næ ¼å¼åŒ–å: ${result}\r\n` + this.dataFlow

            let print = `å‘é€ï¼š${this.currentCMD}\r\nå›å¤: ${this.tem}\r\næ ¼å¼åŒ–å: ${result}`
            console.log(print);
            this.tem = '' // æ¥æ”¶å®Œæˆã€‚é‡åˆ¶æ•°æ®
            if((this.currentIndex + 1) < this.queue.length ){
              this.currentIndex++
              this.writeCmd()
            }else{
              this.queue = []
              this.currentIndex = 0
              this.errMsg = `å‘é€ ${this.currentCMD} å®Œæˆ`
              console.log('===== é˜Ÿåˆ—å·²æ‰§è¡Œå®Œæˆ =====')
            }
          }
        });
      },
      formatData(cmd, data){
        let result = 'NO DATA'
        if(data.includes('NO DATA')){
          console.warn('æ— æ•°æ®', cmd, data)
        }
        if (cmd.substring(0, 2) === '01'){
          let condition = ['0100', '0120', '0140', '0101', '0141'].includes(cmd)
          result = condition ? getSupport(cmd, data) : get$01(cmd, data)
        }else if(cmd.substring(0, 2) === '02'){
          let condition = ['0200', '0220', '0240'].includes(cmd.substring(0, 4))
          result =  condition ? getSupport$02(cmd, data) : get$02(cmd, data)
        }else if(['03', '07', '0A'].includes(cmd)){
          result = getDTC(cmd, data)
        }else if(cmd.substring(0, 2) === '05'){
          let condition = ["0500", "0520", "0540", "0560", "0580", "05A0", "05C0", "05E0"].includes(cmd.substring(0, 4))
          result = condition ? getSupport(cmd, data): get$05(cmd, data)
        }else if(cmd.substring(0, 2) === '06'){
          let condition = ["0600", "0620", "0640", "0660", "0680", "06A0", "06C0", "06E0"].includes(cmd.substring(0, 4))
          result = condition ? getSupport(cmd, data): get$06(cmd, data)
        }else if(cmd.substring(0, 2) === '09'){
          let condition = '0900' === cmd
          result = condition ? getSupport(cmd, data): get$09(cmd, data)
        }else if(['10', '3E', "27", "22", "2E", "14", "19"].includes(cmd.substring(0, 2))){
          let condition = cmd.substring(0, 4) === '1902'
          result = condition ? getUDSDTC(cmd, data): data
        }else if(cmd.substring(0, 2) === 'AT'){
          result = data.replace(/[ ]|[\r]|[\n]|[\r\n]|[>]/g, "")
          if(cmd === 'ATDP'){
            // ã€é‡è¦ã€‘æŠŠéœ€è¦ä½¿ç”¨çš„åè®®å­˜å‚¨åœ¨ç¼“å­˜å†…,è§£ææ•°æ®éœ€è¦ç”¨åˆ° wx.getStorageSync('____ATDP')
            // wx.setStorageSync('____ATDP', result)
            // ã€é‡è¦ã€‘æŠŠéœ€è¦ä½¿ç”¨çš„åè®®å­˜å‚¨åœ¨ç¼“å­˜å†…,è§£ææ•°æ®éœ€è¦ç”¨åˆ° localStorage.getItem('____ATDP')
            localStorage.setItem('____ATDP', result);
            this.ATDP = result
          }
        }else{
          result = data
        }
        console.log('æ ¼å¼åŒ–åçš„ç»“æœ', cmd, result)
        return result
      },
      custom_pid(){
        if(!this.isConnected){
          alert('é”™è¯¯ï¼è¯·å…ˆè¿æ¥è“ç‰™å†æµ‹è¯•ï¼')
          return
        }
        this.queue.push(this.inputValue)
        this.writeCmd()
      },
      
      test_pid(){
        if(!this.isConnected){
          alert('é”™è¯¯ï¼è¯·å…ˆè¿æ¥è“ç‰™å†æµ‹è¯•ï¼')
          return
        }
        // æ‰§è¡Œé»˜è®¤é˜Ÿåˆ—
        let queue = ["ATRV",  "020200", "020000", "022000", "024000", "020C00", "020D00", "03", "07", "0A", "04", "05", "06", "0900", "0902", "0904", "0906", "0908", "090A", "090B", "010C", "010D"]
        for (let i = 0; i < 96; i++) {
          let hex = i.toString(16).toUpperCase()
          let cmd_01 =  (hex.length < 2 ? "010" : '01') + hex
          queue.push(cmd_01)
        }
        this.queue = queue
        this.writeCmd()
      },
      formatTime() {
        let date = new Date()
        const year = date.getFullYear()
        const month = date.getMonth() + 1
        const day = date.getDate()
        const hour = date.getHours()
        const minute = date.getMinutes()
        const second = date.getSeconds()
        const milliseconds = date.getMilliseconds()
        const formatNumber = n => {
            n = n.toString()
            return n[1] ? n : '0' + n
        }
        return [year, month, day].map(formatNumber).join('-') + ' ' + [hour, minute, second].map(formatNumber).join(':') + ':' + milliseconds 
      },
      // å­—ç¬¦ä¸²è½¬ArrayBuffer
      textEncoder: function(cmd){
        let str = cmd + '\r'
        if(this.isEncrypted){
          str = encrypt(str)
        }
        let result = new TextEncoder().encode(str).buffer
        return result
      },
      // ArrayBufferè½¬å­—ç¬¦ä¸²
      textDecoder: function(value){
        let result = new TextDecoder().decode(value)
        if(this.isEncrypted){
          result = decrypt(result)
        }
        return result
      },
    }
  })

  </script>
</body>
</html>